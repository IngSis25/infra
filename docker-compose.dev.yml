version: "3.9"

services:
  # ======================
  # Reverse Proxy (NGINX)
  # ======================
  reverse-proxy:
    image: nginx:alpine
    container_name: reverse-proxy
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./conf.d/nginx.conf:/etc/nginx/conf.d/default.conf:ro
      - /etc/letsencrypt:/etc/letsencrypt:ro
    depends_on:
      - ui-service
      - authorization-service
      - snippet-service
      - runner-service
      - asset-service
    networks:
      - printscript-net
    restart: unless-stopped

  # ======================
  # UI
  # ======================
  ui-service:
    image: ghcr.io/ingsis25/printscript-ui-dev:latest
    container_name: ui-service
    expose:
      - "80"
    networks:
      - printscript-net
    restart: unless-stopped

  # ======================
  # Redis
  # ======================
  redis:
    image: redis:7-alpine
    container_name: redis
    ports:
      - "6379:6379"
    networks:
      - printscript-net
    restart: unless-stopped

  # ======================
  # AUTH DB
  # ======================
  auth-db:
    image: postgres:15
    container_name: auth-db
    environment:
      POSTGRES_DB: authorization-serviceDB
      POSTGRES_USER: Printscript
      POSTGRES_PASSWORD: ${SPRING_DATASOURCE_PASSWORD_AUTHDB}
    volumes:
      - auth-db-data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U Printscript -d authorization-serviceDB"]
      interval: 5s
      timeout: 3s
      retries: 20
    networks:
      - printscript-net
    restart: unless-stopped

  # ======================
  # AUTHORIZATION SERVICE
  # ======================
  authorization-service:
    image: ghcr.io/ingsis25/authorization-service:dev
    container_name: authorization-service
    environment:
      SPRING_DATASOURCE_URL: jdbc:postgresql://auth-db:5432/authorization-serviceDB
      SPRING_DATASOURCE_USERNAME: Printscript
      SPRING_DATASOURCE_PASSWORD: ${SPRING_DATASOURCE_PASSWORD_AUTHDB}

      SPRING_DATA_REDIS_HOST: redis
      SPRING_DATA_REDIS_PORT: 6379

      AUTH_SERVER_URI: https://dev-2dc74voarsscuyp0.us.auth0.com
      SPRING_SECURITY_OAUTH2_RESOURCESERVER_JWT_ISSUER_URI: https://dev-2dc74voarsscuyp0.us.auth0.com

      AUTH0_MANAGEMENT_AUDIENCE: ${AUTH0_MANAGEMENT_AUDIENCE}
      AUTH0_MANAGEMENT_CLIENT_ID: ${AUTH0_MANAGEMENT_CLIENT_ID}
      AUTH0_MANAGEMENT_CLIENT_SECRET: ${AUTH0_MANAGEMENT_CLIENT_SECRET}

      NEW_RELIC_LICENSE_KEY: ${NEW_RELIC_LICENSE_KEY}
      NEW_RELIC_APP_NAME: authorization-service
    depends_on:
      auth-db:
        condition: service_healthy
      redis:
        condition: service_started
    networks:
      - printscript-net
    restart: unless-stopped

  # ======================
  # SNIPPET DB
  # ======================
  snippet-db:
    image: postgres:15
    container_name: snippet-db
    environment:
      POSTGRES_DB: snippet-serviceDB
      POSTGRES_USER: ${SPRING_DATASOURCE_USERNAME_SNIPPET}
      POSTGRES_PASSWORD: ${SPRING_DATASOURCE_PASSWORD_SNIPPET}
    volumes:
      - snippet-db-data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${SPRING_DATASOURCE_USERNAME_SNIPPET} -d snippet-serviceDB"]
      interval: 5s
      timeout: 3s
      retries: 20
    networks:
      - printscript-net
    restart: unless-stopped

  # ======================
  # SNIPPET SERVICE
  # ======================
  snippet-service:
    image: ghcr.io/ingsis25/snippet-service:dev
    container_name: snippet-service
    environment:
      SPRING_DATASOURCE_URL: jdbc:postgresql://snippet-db:5432/snippet-serviceDB
      SPRING_DATASOURCE_USERNAME: ${SPRING_DATASOURCE_USERNAME_SNIPPET}
      SPRING_DATASOURCE_PASSWORD: ${SPRING_DATASOURCE_PASSWORD_SNIPPET}

      SPRING_DATA_REDIS_HOST: redis
      SPRING_DATA_REDIS_PORT: 6379

      AUTH_SERVER_URI: https://dev-2dc74voarsscuyp0.us.auth0.com
      SPRING_SECURITY_OAUTH2_RESOURCESERVER_JWT_ISSUER_URI: https://dev-2dc74voarsscuyp0.us.auth0.com

      AUTH_AUDIENCE: ${AUTH_AUDIENCE}
      AUTH_CLIENT_ID: ${AUTH_CLIENT_ID}

      NEW_RELIC_LICENSE_KEY: ${NEW_RELIC_LICENSE_KEY}
      NEW_RELIC_APP_NAME: snippet-service
    depends_on:
      snippet-db:
        condition: service_healthy
      redis:
        condition: service_started
    networks:
      - printscript-net
    restart: unless-stopped

  # ======================
  # AZURITE
  # ======================
  azurite:
    image: mcr.microsoft.com/azure-storage/azurite
    container_name: azurite
    hostname: azurite
    ports:
      - "10000:10000"
      - "10001:10001"
      - "10002:10002"
    volumes:
      - azurite-data:/workspace
    networks:
      - printscript-net
    restart: unless-stopped

  # ======================
  # ASSET SERVICE
  # ======================
  asset-service:
    image: ghcr.io/austral-ingsis/snippet-asset-service:latest
    container_name: asset-service
    environment:
      AZURE_HOST: "http://azurite:10000"
      NEW_RELIC_AGENT_ENABLED: "false"
      NEW_RELIC_APP_NAME: "asset-service"
    depends_on:
      - azurite
    networks:
      - printscript-net
    restart: unless-stopped

  # ======================
  # RUNNER SERVICE
  # ======================
  runner-service:
    image: ghcr.io/ingsis25/runner-service:dev
    container_name: runner-service
    environment:
      SPRING_DATA_REDIS_HOST: redis
      SPRING_DATA_REDIS_PORT: 6379

      AUTH_SERVER_URI: https://dev-2dc74voarsscuyp0.us.auth0.com
      SPRING_SECURITY_OAUTH2_RESOURCESERVER_JWT_ISSUER_URI: https://dev-2dc74voarsscuyp0.us.auth0.com

      NEW_RELIC_LICENSE_KEY: ${NEW_RELIC_LICENSE_KEY}
      NEW_RELIC_APP_NAME: runner-service
    depends_on:
      redis:
        condition: service_started
      asset-service:
        condition: service_started
    networks:
      - printscript-net
    restart: unless-stopped

networks:
  printscript-net:
    driver: bridge

volumes:
  auth-db-data:
  snippet-db-data:
  azurite-data:
